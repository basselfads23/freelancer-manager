{% extends "base.html" %} {% block title %}Project: {{ project.title }}{%
endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Project: {{ project.title }}</h2>
  <a href="{{ url_for('projects') }}" class="btn btn-secondary"
    >Back to All Projects</a
  >
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between">
    <span>Description</span>
    <span class="text-muted">Client: {{ project.client.name }}</span>
  </div>
  <div class="card-body">
    <p class="card-text">
      {{ project.description or 'No description provided.' }}
    </p>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">Task Checklist</div>
  <div class="card-body">
    <form
      action="{{ url_for('add_task', project_id=project.id) }}"
      method="POST"
      class="d-flex gap-2 mb-4"
    >
      <input
        type="text"
        name="task_description"
        class="form-control"
        placeholder="Add a new task..."
        required
      />
      <button type="submit" class="btn btn-primary">Add Task</button>
    </form>

    <ul class="list-group">
      {% for task in project.tasks %}
      <!-- START: Replacement for the <li> element -->
      <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
          <!-- Task Description and Checkbox -->
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              value=""
              id="task-{{ task.id }}"
              {%
              if
              task.is_completed
              %}checked{%
              endif
              %}
              onchange="toggleTask({{ task.id }})"
            />
            <label
              class="form-check-label {% if task.is_completed %}text-muted text-decoration-line-through{% endif %}"
              for="task-{{ task.id }}"
            >
              {{ task.description }}
            </label>
          </div>

          <!-- DYNAMIC CONTROLS based on Billing Type -->
          <div>
            <!-- HOURLY BILLING CONTROLS -->
            {% if project.billing_type == 'Hourly' %}
            <span class="badge bg-primary me-2"
              >{{ task.total_hours_logged }} hrs logged</span
            >
            <button
              class="btn btn-sm btn-outline-secondary"
              data-bs-toggle="collapse"
              href="#manualLog-{{ task.id }}"
            >
              Log Time
            </button>
            {% elif project.billing_type == 'Per Task' %}
            <button
              class="btn btn-sm btn-outline-secondary"
              data-bs-toggle="collapse"
              href="#taskBilling-{{ task.id }}"
            >
              Edit Billing
            </button>
            {% endif %}
          </div>
        </div>

        <!-- Collapsible Manual Time Log Form (for Hourly projects) -->
        {% if project.billing_type == 'Hourly' %}
        <div class="collapse mt-3" id="manualLog-{{ task.id }}">
          <div class="card card-body bg-light">
            <form
              action="{{ url_for('log_time', task_id=task.id) }}"
              method="POST"
              class="row g-2 align-items-end"
            >
              <div class="col-md-5">
                <label for="hours_worked" class="form-label-sm"
                  >Hours Worked</label
                >
                <input
                  type="number"
                  name="hours_worked"
                  class="form-control form-control-sm"
                  step="0.01"
                  required
                />
              </div>
              <div class="col-md-5">
                <label for="entry_date" class="form-label-sm">Date</label>
                <input
                  type="date"
                  name="entry_date"
                  class="form-control form-control-sm"
                  value="{{ date.today().strftime('%Y-%m-%d') }}"
                />
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-sm btn-success w-100">
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
        {% endif %} {% if project.billing_type == 'Per Task' %}
        <div class="collapse mt-3" id="taskBilling-{{ task.id }}">
          <div class="card card-body bg-light">
            <form
              action="{{ url_for('update_task_billing', task_id=task.id) }}"
              method="POST"
              class="row g-2 align-items-end"
            >
              <div class="col-md-5">
                <label for="task_fee" class="form-label-sm">Task Fee ($)</label>
                <input
                  type="number"
                  name="task_fee"
                  class="form-control form-control-sm"
                  step="0.01"
                  value="{{ task.task_fee or '' }}"
                  placeholder="e.g., 150.00"
                />
              </div>
              <div class="col-md-5">
                <label for="quantity" class="form-label-sm">Quantity</label>
                <input
                  type="number"
                  name="quantity"
                  class="form-control form-control-sm"
                  step="1"
                  value="{{ task.quantity or 1 }}"
                />
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-sm btn-success w-100">
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
        {% endif %}
      </li>
      <!-- END: Replacement for the <li> element -->
      {% else %}
      <li class="list-group-item text-center fst-italic">No tasks yet.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">Project Notes</div>
  <div class="card-body">
    <form
      action="{{ url_for('save_notes', project_id=project.id) }}"
      method="POST"
    >
      <div class="mb-3">
        <textarea
          name="notes"
          class="form-control"
          rows="8"
          placeholder="Add any private notes, thoughts, or reminders here..."
        >
{{ project.notes or '' }}</textarea
        >
      </div>
      <button type="submit" class="btn btn-primary">Save Notes</button>
    </form>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function toggleTask(taskId) {
    fetch(`/toggle_task/${taskId}`, {
      method: "POST",
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Find the label and toggle its style
          const label = document.querySelector(`label[for="task-${taskId}"]`);
          if (data.is_completed) {
            label.classList.add("text-muted", "text-decoration-line-through");
          } else {
            label.classList.remove(
              "text-muted",
              "text-decoration-line-through"
            );
          }
          // We can optionally update the main project progress bar here later
        }
      });
  }
</script>
{% endblock %}
