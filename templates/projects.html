{% extends "base.html" %} {% block content %}
<h2>Projects</h2>

<form method="POST" class="mb-4 p-3 border rounded bg-white">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <select name="client_id" id="client_select" class="form-select" required>
        <option value="" disabled selected>Select a client...</option>
        {% for client in clients %}
        <option value="{{ client.id }}" {% if client.id == new_client_id %}selected{% endif %}>{{ client.name }}</option>
        {% endfor %}
        <option value="add_new_client" style="font-weight: bold; border-top: 1px solid #ccc; padding-top: 5px;">+ Add New Client</option>

      </select>
    </div>
    <div class="col-md-3">
      <label for="title" class="form-label">Project Title</label>
      <input
        type="text"
        name="title"
        id="title"
        class="form-control"
        required
      />
    </div>
    <div class="col-md-3">
      <label for="description" class="form-label">Notes</label>
      <input
        type="text"
        name="description"
        id="description"
        class="form-control"
      />
    </div>
    <div class="col-md-2">
      <label for="deadline" class="form-label">Deadline</label>
      <input type="date" name="deadline" id="deadline" class="form-control" />
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-primary w-100">Add</button>
    </div>
  </div>
</form>

<div class="card">
  <div class="card-header">Project List</div>
  <ul class="list-group list-group-flush">
    {% for project in projects %}
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="badge bg-secondary mb-2">{{ project.client.name }}</span>
          <h5 class="mb-1">
            <a
              href="{{ url_for('project_detail', project_id=project.id) }}"
              class="text-decoration-none text-dark"
              >{{ project.title }}</a
            >
          </h5>
          <p class="mb-1 text-muted">{{ project.description }}</p>

          {% if project.total_tasks > 0 %}
          <div class="progress mt-2" style="height: 20px">
            <div
              class="progress-bar"
              role="progressbar"
              style="width: {{ (project.completed_tasks / project.total_tasks) * 100 }}%;"
              aria-valuenow="{{ project.completed_tasks }}"
              aria-valuemin="0"
              aria-valuemax="{{ project.total_tasks }}"
            >
              {{ project.completed_tasks }} / {{ project.total_tasks }} Complete
            </div>
          </div>
          {% endif %}
        </div>
        <div class="text-end">
          {% if project.days_left is not none %} {% if project.days_left < 0 %}
          <span class="badge bg-danger"
            >Overdue by {{ project.days_left|abs }} days</span
          >
          {% elif project.days_left == 0 %}
          <span class="badge bg-warning">Due today</span>
          {% else %}
          <span class="badge bg-success"
            >Due in {{ project.days_left }} days</span
          >
          {% endif %}
          <small class="d-block text-muted"
            >{{ project.deadline.strftime('%Y-%m-%d') }}</small
          >
          {% else %}
          <span class="badge bg-secondary">No deadline set</span>
          {% endif %}

          <form
            action="{{ url_for('delete_project', project_id=project.id) }}"
            method="POST"
            class="d-inline"
            onsubmit="return confirm('Are you sure you want to delete this project?');"
          >
            <button type="submit" class="btn btn-danger btn-sm mt-2">
              Delete
            </button>
          </form>
        </div>
      </div>
    </li>
    {% else %}
    <li class="list-group-item">
      No projects yet. Add one using the form above!
    </li>
    {% endfor %}
  </ul>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.getElementById('client_select').addEventListener('change', function() {
    if (this.value === 'add_new_client') {
      // If the user selects "Add New Client", redirect them.
      window.location.href = "{{ url_for('clients', next='projects') }}";
    }
  });
</script>
{% endblock %}