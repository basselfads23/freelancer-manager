{% extends "base.html" %} {% block content %}
<h2>Projects</h2>

<!-- START: New Project Creation Form -->
<form method="POST" class="mb-4 p-3 border rounded bg-white">
  <div class="row g-3">
    <!-- Project Title -->
    <div class="col-md-6">
      <label for="title" class="form-label">Project Title</label>
      <input type="text" name="title" id="title" class="form-control" required>
    </div>

    <!-- Client -->
    <div class="col-md-6">
      <label for="client_select" class="form-label">Client</label>
      <select name="client_id" id="client_select" class="form-select" required>
        <option value="" disabled selected>Select a client...</option>
        {% for client in clients %}
        <option value="{{ client.id }}" {% if client.id == new_client_id %}selected{% endif %}>{{ client.name }}</option>
        {% endfor %}
        <option value="add_new_client" style="font-weight: bold; border-top: 1px solid #ccc; padding-top: 5px;">+ Add New Client</option>
      </select>
    </div>

    <!-- Description -->
    <div class="col-12">
      <label for="description" class="form-label">Description</label>
      <input type="text" name="description" id="description" class="form-control">
    </div>

    <!-- Billing Type -->
    <div class="col-md-4">
      <label for="billing_type" class="form-label">Billing Type</label>
      <select name="billing_type" id="billing_type" class="form-select">
        <option value="Hourly">Hourly Rate</option>
        <option value="Flat Fee">Flat Fee</option>
        <option value="Per Task">Per Task</option>
      </select>
    </div>

    <!-- Hourly Rate (Initially Hidden) -->
    <div class="col-md-4" id="hourly_rate_div">
      <label for="hourly_rate" class="form-label">Hourly Rate ($)</label>
      <input type="number" name="hourly_rate" id="hourly_rate" class="form-control" step="0.01" min="0.01" placeholder="e.g., 50.00">
    </div>

    <!-- Flat Fee (Initially Hidden) -->
    <div class="col-md-4" id="flat_fee_div" style="display: none;">
      <label for="flat_fee_amount" class="form-label">Flat Fee Amount ($)</label>
      <input type="number" name="flat_fee_amount" id="flat_fee_amount" class="form-control" step="0.01" min="0.01" placeholder="e.g., 1500.00">
    </div>

    <!-- Deadline -->
    <div class="col-md-4">
      <label for="deadline" class="form-label">Deadline</label>
      <input type="date" name="deadline" id="deadline" class="form-control">
    </div>

    <!-- Submit Button -->
    <div class="col-12 text-end">
      <button type="submit" class="btn btn-primary">Create Project</button>
    </div>
  </div>
</form>
<!-- END: New Project Creation Form -->

<div class="card">
  <div class="card-header">Project List</div>
  <ul class="list-group list-group-flush">
    {% for project in projects %}
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="badge bg-secondary mb-2">{{ project.client.name }}</span>
          <h5 class="mb-1">
            {{ project.title }}
                <span class="badge bg-info fw-normal ms-2">{{ project.billing_type }}</span>
          </h5>
          <p class="mb-1 text-muted">{{ project.description }}</p>

          {% if project.total_tasks > 0 %}
          <div class="progress mt-2" style="height: 20px">
            <div
              class="progress-bar"
              role="progressbar"
              style="width: {{ (project.completed_tasks / project.total_tasks) * 100 }}%;"
              aria-valuenow="{{ project.completed_tasks }}"
              aria-valuemin="0"
              aria-valuemax="{{ project.total_tasks }}"
            >
              {{ project.completed_tasks }} / {{ project.total_tasks }} Complete
            </div>
          </div>
          {% endif %}
        </div>
        <div class="text-end">
          {% if project.days_left is not none %} {% if project.days_left < 0 %}
          <span class="badge bg-danger"
            >Overdue by {{ project.days_left|abs }} days</span
          >
          {% elif project.days_left == 0 %}
          <span class="badge bg-warning">Due today</span>
          {% else %}
          <span class="badge bg-success"
            >Due in {{ project.days_left }} days</span
          >
          {% endif %}
          <small class="d-block text-muted"
            >{{ project.deadline.strftime('%Y-%m-%d') }}</small
          >
          {% else %}
          <span class="badge bg-secondary">No deadline set</span>
          {% endif %}

          <a href="{{ url_for('main.project_detail', project_id=project.id) }}" class="btn btn-outline-primary btn-sm mt-2">View / Edit</a>

          <form
            action="{{ url_for('main.delete_project', project_id=project.id) }}"
            method="POST"
            class="d-inline"
            onsubmit="return confirm('Are you sure you want to delete this project?');"
          >
            <button type="submit" class="btn btn-danger btn-sm mt-2">
              Delete
            </button>
          </form>
        </div>
      </div>
    </li>
    {% else %}
    <li class="list-group-item">
      No projects yet. Add one using the form above!
    </li>
    {% endfor %}
  </ul>
</div>

{% endblock %}

{% block scripts %}
<script>
  // For the "+ Add New Client" dropdown option
  document.getElementById('client_select').addEventListener('change', function() {
    if (this.value === 'add_new_client') {
      window.location.href = "{{ url_for('main.clients', next='projects') }}";
    }
  });

  // For the dynamic billing type fields
  document.getElementById('billing_type').addEventListener('change', function() {
    const hourlyDiv = document.getElementById('hourly_rate_div');
    const flatFeeDiv = document.getElementById('flat_fee_div');

    if (this.value === 'Hourly') {
      hourlyDiv.style.display = 'block';
      flatFeeDiv.style.display = 'none';
    } else if (this.value === 'Flat Fee') {
      hourlyDiv.style.display = 'none';
      flatFeeDiv.style.display = 'block';
    } else { // Per Task
      hourlyDiv.style.display = 'none';
      flatFeeDiv.style.display = 'none';
    }
  });
</script>
{% endblock %}